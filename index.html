<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πà‡∏≠‡∏° API (V4)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-900 p-4 min-h-screen text-gray-200">

    <div class="max-w-md mx-auto bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
        <div class="bg-red-600 p-4 text-white">
            <h1 class="text-xl font-bold">üõ†Ô∏è Diagnostics V4</h1>
            <p class="text-sm opacity-90">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏∂‡∏Å</p>
        </div>

        <div class="p-4 space-y-4">
            
            <!-- Console Screen -->
            <div id="console" class="bg-black p-3 rounded font-mono text-xs h-64 overflow-y-auto border border-gray-600 space-y-1">
                <div class="text-gray-500">--- System Start ---</div>
            </div>

            <!-- Manual Controls -->
            <div class="pt-2">
                <button id="authBtn" class="bg-blue-600 text-white px-4 py-3 rounded w-full font-bold opacity-50 cursor-not-allowed" disabled>
                    ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...
                </button>
            </div>

        </div>
    </div>

    <!-- Script Loaders with Error Traps -->
    <script src="https://apis.google.com/js/api.js" 
            onload="log('‚úÖ Google API Script (gapi) loaded', 'success'); gapiLoaded();" 
            onerror="log('‚ùå Google API Script (gapi) FAILED to load! ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏£‡∏∑‡∏≠ Firewall', 'error')">
    </script>
    
    <script src="https://accounts.google.com/gsi/client" 
            onload="log('‚úÖ Google Identity Script (gis) loaded', 'success'); gisLoaded();" 
            onerror="log('‚ùå Google Identity Script (gis) FAILED to load!', 'error')">
    </script>

    <script>
        // ==========================================
        const CLIENT_ID = '395031237674-6j28i27or4lk6t3m342srbefukr1fp1d.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyANFH1JUJ8Y29ImxTYwBdSV6V7-xWfHd90'; 
        // ==========================================

        let tokenClient;
        let isGapiReady = false;
        let isGisReady = false;

        function log(msg, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const colorClass = type === 'error' ? 'text-red-400 font-bold' : (type === 'success' ? 'text-green-400' : 'text-gray-300');
            
            // Format Object
            if (typeof msg === 'object') msg = JSON.stringify(msg, null, 2);
            
            consoleDiv.innerHTML += `<div class="${colorClass}">> ${msg}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight; // Auto scroll
        }

        function checkReady() {
            if(isGapiReady && isGisReady) {
                const btn = document.getElementById('authBtn');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('hover:bg-blue-700');
                btn.innerText = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö (Start)';
                log('üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢', 'success');
            }
        }

        // 1. Initialize GAPI
        function gapiLoaded() {
            gapi.load('client', async () => {
                log('‡∏Å‡∏≥‡∏•‡∏±‡∏á Initialize GAPI Client...');
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    });
                    
                    // Double Check
                    if (gapi.client.drive) {
                        log('‚úÖ GAPI Init Success: Drive API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
                        isGapiReady = true;
                        checkReady();
                    } else {
                        throw new Error("Init ‡∏ú‡πà‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡∏≤ Drive API ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠");
                    }

                } catch (err) {
                    log('‚ùå GAPI Init Error (‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç):', 'error');
                    
                    if (err.result && err.result.error) {
                        log(`Code: ${err.result.error.code}`);
                        log(`Message: ${err.result.error.message}`);
                        if(err.result.error.code === 403) log('üëâ ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: API Key ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å (Restrict) ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î Drive API');
                    } else {
                        log(err);
                    }
                }
            });
        }

        // 2. Initialize GIS
        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.readonly',
                    callback: async (resp) => {
                        if (resp.error) {
                            log('‚ùå Login Error: ' + JSON.stringify(resp), 'error');
                            return;
                        }
                        log('‚úÖ Login Success! Token ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        
                        // Auto Trigger Test
                        testApiCall();
                    },
                });
                isGisReady = true;
                checkReady();
            } catch (err) {
                log('‚ùå GIS Init Error: ' + err.message, 'error');
            }
        }

        // 3. User Click Action
        document.getElementById('authBtn').onclick = () => {
            log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Requesting Token)...');
            tokenClient.requestAccessToken({prompt: 'consent'});
        };

        // 4. Final API Test
        async function testApiCall() {
            log('‚ö° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á...');
            try {
                const response = await gapi.client.drive.files.list({
                    'pageSize': 1,
                    'fields': 'files(id, name)',
                });
                log('üéâüéâ ‡πÑ‡∏ä‡πÇ‡∏¢! ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß üéâüéâ', 'success');
                log(`‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ${response.result.files[0]?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥)'}`);
                
                alert("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°) ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");

            } catch (err) {
                log('‚ùå API Call Error (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ):', 'error');
                log(err);
            }
        }
    </script>
</body>
</html>


