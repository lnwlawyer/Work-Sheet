<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostics V6 (Auto-Wait)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body{font-family:sans-serif;}</style>
</head>
<body class="bg-gray-800 p-4 min-h-screen text-white">

    <div class="max-w-md mx-auto bg-gray-900 rounded-xl shadow-lg border border-gray-700 overflow-hidden">
        <div class="bg-blue-900 p-4 border-b border-blue-800">
            <h1 class="text-xl font-bold">üõ†Ô∏è V6: Auto-Wait System</h1>
            <p class="text-xs text-blue-300">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>

        <div class="p-6 space-y-6">
            
            <!-- Status Monitor -->
            <div class="space-y-3 text-sm font-mono">
                <div class="flex justify-between items-center bg-gray-800 p-2 rounded">
                    <span>1. GAPI (Data):</span>
                    <span id="status-gapi" class="text-yellow-500">‚è≥ ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
                <div class="flex justify-between items-center bg-gray-800 p-2 rounded">
                    <span>2. GIS (Login):</span>
                    <span id="status-gis" class="text-yellow-500">‚è≥ ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="space-y-3">
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏° -->
                <button id="btn-login" onclick="doLogin()" class="w-full bg-gray-600 text-gray-400 py-3 rounded-lg font-bold cursor-not-allowed transition-all" disabled>
                    üö´ ‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Google...
                </button>

                <button id="btn-test" onclick="doTest()" class="w-full bg-gray-700 text-gray-500 py-3 rounded-lg font-bold cursor-not-allowed transition-all" disabled>
                    üìÇ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>

            <!-- Console -->
            <div class="bg-black text-green-400 p-3 rounded text-xs font-mono h-48 overflow-y-auto border border-gray-700" id="console">
                > System Started...<br>
                > Waiting for Google Libraries...
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        const CLIENT_ID = '395031237674-6j28i27or4lk6t3m342srbefukr1fp1d.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyANFH1JUJ8Y29ImxTYwBdSV6V7-xWfHd90'; 

        let tokenClient;
        let gapiReady = false;
        let gisReady = false;

        function log(msg, type='info') {
            const c = document.getElementById('console');
            const color = type === 'error' ? 'text-red-400' : 'text-green-400';
            c.innerHTML += `<div class="${color}">> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        function setStatus(id, text, type) {
            const el = document.getElementById(id);
            el.innerHTML = text;
            el.className = type === 'success' ? 'text-green-400 font-bold' : 'text-red-400 font-bold';
        }

        // --- CORE: Auto Check Loop ---
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡πÜ 0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ß‡πà‡∏≤ Google ‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const checkInterval = setInterval(() => {
            
            // 1. Check GAPI
            if(!gapiReady && typeof gapi !== 'undefined') {
                log('GAPI Script found. Initializing...');
                gapiReady = true;
                initGapi();
            }

            // 2. Check GIS (‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
            if(!gisReady && typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                log('GIS Script found. Initializing...');
                gisReady = true;
                initGis();
            }

            // 3. Enable Button when both ready
            if(gapiReady && gisReady) {
                clearInterval(checkInterval); // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ
                log('üöÄ SYSTEM READY! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢');
                const btn = document.getElementById('btn-login');
                btn.disabled = false;
                btn.className = 'w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-500 shadow-lg cursor-pointer';
                btn.innerText = 'üîê ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô (Login)';
            }

        }, 500);

        // Init GAPI
        function initGapi() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    });
                    setStatus('status-gapi', '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
                    log('GAPI Client Initialized');
                } catch(e) {
                    setStatus('status-gapi', '‚ùå Error', 'error');
                    log('GAPI Init Error: ' + JSON.stringify(e), 'error');
                }
            });
        }

        // Init GIS
        function initGis() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.readonly',
                    callback: (resp) => {
                        if(resp.error) {
                            log('Auth Error: ' + JSON.stringify(resp), 'error');
                            return;
                        }
                        log('‚úÖ Access Token Received!');
                        enableTestBtn();
                    },
                });
                setStatus('status-gis', '‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
                log('GIS Client Initialized');
            } catch(e) {
                setStatus('status-gis', '‚ùå Init Failed', 'error');
                log('GIS Init Error: ' + e.message, 'error');
            }
        }

        function enableTestBtn() {
            const btn = document.getElementById('btn-test');
            btn.disabled = false;
            btn.className = 'w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-500 shadow-lg cursor-pointer';
            btn.innerText = 'üìÇ 3. ‡∏Å‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        }

        function doLogin() {
            if(!tokenClient) { log('Client not ready yet...', 'error'); return; }
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        async function doTest() {
            log('Testing API Call...');
            try {
                const res = await gapi.client.drive.files.list({
                    'pageSize': 1,
                    'fields': 'files(id, name)'
                });
                log(`üéâ SUCCESS! Found ${res.result.files.length} files`, 'success');
                if(res.result.files.length > 0) log('File: ' + res.result.files[0].name);
                alert("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö");
            } catch(e) {
                log('API Error: ' + JSON.stringify(e), 'error');
            }
        }
    </script>
</body>
</html>


